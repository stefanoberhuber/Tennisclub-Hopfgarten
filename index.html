<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Vereinskühlschrank</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background: #f4f6f9;
}

h1 {
  text-align: center;
}

#status {
  position: fixed;
  top: 15px;
  right: 20px;
  font-weight: bold;
}

.online { color: green; }
.offline { color: red; }

.search-box {
  width: 100%;
  padding: 15px;
  font-size: 20px;
  margin-bottom: 15px;
}

.member-list {
  max-height: 200px;
  overflow-y: auto;
  background: white;
  border-radius: 8px;
  padding: 10px;
}

.member-item {
  padding: 12px;
  font-size: 18px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}

.member-item:hover {
  background: #e8f0ff;
}

.product-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
  gap: 10px;
  margin-top: 20px;
}

.product-btn {
  padding: 20px;
  font-size: 18px;
  border-radius: 8px;
  border: none;
  background: #007bff;
  color: white;
  cursor: pointer;
}

.product-btn:hover {
  background: #0056b3;
}

.selected-product {
  background: #28a745 !important;
}

.quantity-box {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-top: 20px;
}

.quantity-box button {
  font-size: 24px;
  padding: 10px 20px;
}

.quantity-box span {
  font-size: 24px;
  margin: 0 20px;
}

.total {
  text-align: center;
  font-size: 22px;
  margin-top: 15px;
}

.save-btn {
  padding: 18px;
  font-size: 20px;
  width: 100%;
  margin-top: 20px;
  background: #28a745;
  color: white;
  border: none;
  border-radius: 8px;
}
</style>
</head>

<body>

<div id="status" class="offline">● Offline</div>

<h1>Vereinskühlschrank</h1>

<input type="text" id="search" class="search-box" placeholder="Mitglied suchen...">

<div id="memberList" class="member-list"></div>

<h2>Produkte</h2>
<div id="productGrid" class="product-grid"></div>

<div class="quantity-box">
  <button onclick="changeQuantity(-1)">−</button>
  <span id="quantity">1</span>
  <button onclick="changeQuantity(1)">+</button>
</div>

<div class="total" id="totalPrice">Gesamt: 0 €</div>

<button class="save-btn" onclick="saveEntry()">Entnahme speichern</button>

<script>
const SUPABASE_URL = "https://lzrbcphditfrgvfoswpr.supabase.co";
const SUPABASE_KEY = "sb_publishable_-C9ojxpR5NcQfi2NiEii5w_wi5rVblM";

let members = [];
let products = [];
let selectedMember = null;
let selectedProduct = null;
let quantity = 1;

async function checkConnection() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/mitglieder?select=id&limit=1`, {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`
      }
    });

    if (res.ok) {
      document.getElementById("status").textContent = "● Online";
      document.getElementById("status").className = "online";
    } else {
      throw new Error();
    }
  } catch {
    document.getElementById("status").textContent = "● Offline";
    document.getElementById("status").className = "offline";
  }
}

async function loadMembers() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/mitglieder?select=*`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`
    }
  });
  members = await res.json();
  renderMembers(members);
}

async function loadProducts() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/produkte?select=*`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`
    }
  });
  products = await res.json();
  renderProducts();
}

function renderMembers(list) {
  const container = document.getElementById("memberList");
  container.innerHTML = "";

  list.forEach(m => {
    const div = document.createElement("div");
    div.className = "member-item";
    div.textContent = m.name;
    div.onclick = () => {
      selectedMember = m;
      alert("Mitglied: " + m.name);
    };
    container.appendChild(div);
  });
}

document.getElementById("search").addEventListener("input", e => {
  const value = e.target.value.toLowerCase();
  const filtered = members.filter(m => m.name.toLowerCase().includes(value));
  renderMembers(filtered);
});

function renderProducts() {
  const grid = document.getElementById("productGrid");
  grid.innerHTML = "";

  products.forEach(p => {
    const btn = document.createElement("button");
    btn.className = "product-btn";
    btn.textContent = p.name + " (" + p.preis + "€)";
    btn.onclick = () => selectProduct(p, btn);
    grid.appendChild(btn);
  });
}

function selectProduct(product, button) {
  selectedProduct = product;
  document.querySelectorAll(".product-btn").forEach(b => b.classList.remove("selected-product"));
  button.classList.add("selected-product");
  updateTotal();
}

function changeQuantity(delta) {
  quantity += delta;
  if (quantity < 1) quantity = 1;
  document.getElementById("quantity").textContent = quantity;
  updateTotal();
}

function updateTotal() {
  if (!selectedProduct) return;
  const total = (selectedProduct.preis * quantity).toFixed(2);
  document.getElementById("totalPrice").textContent = "Gesamt: " + total + " €";
}

async function saveEntry() {
  if (!selectedMember || !selectedProduct) {
    alert("Bitte Mitglied und Produkt auswählen");
    return;
  }

  const total = selectedProduct.preis * quantity;

  await fetch(`${SUPABASE_URL}/rest/v1/entnahmen`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json",
      Prefer: "return=representation"
    },
    body: JSON.stringify([{
      mitglied_id: selectedMember.id,
      produkt_id: selectedProduct.id,
      menge: quantity,
      gesamtpreis: total,
      bezahlt: false
    }])
  });

  alert("Gespeichert ✅");

  quantity = 1;
  document.getElementById("quantity").textContent = 1;
  document.getElementById("totalPrice").textContent = "Gesamt: 0 €";
  document.querySelectorAll(".product-btn").forEach(b => b.classList.remove("selected-product"));
  selectedProduct = null;
}

checkConnection();
loadMembers();
loadProducts();
document.getElementById("search").focus();
</script>

</body>
</html>
