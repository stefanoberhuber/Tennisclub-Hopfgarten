<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Vereinskühlschrank</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 20px;
  background: #f4f6f9;
}

h1 {
  text-align: center;
}

#status {
  position: fixed;
  top: 15px;
  right: 20px;
  font-weight: bold;
}

.online { color: green; }
.offline { color: red; }

.search-box {
  width: 100%;
  padding: 15px;
  font-size: 20px;
  margin-bottom: 15px;
}

.member-list {
  max-height: 300px;
  overflow-y: auto;
  background: white;
  border-radius: 8px;
  padding: 10px;
}

.member-item {
  padding: 12px;
  font-size: 18px;
  border-bottom: 1px solid #eee;
  cursor: pointer;
}

.member-item:hover {
  background: #e8f0ff;
}

.selected {
  background: #cce0ff;
}

.section-title {
  margin-top: 20px;
  font-weight: bold;
}

button {
  padding: 15px;
  font-size: 18px;
  width: 100%;
  margin-top: 15px;
  background: #007bff;
  color: white;
  border: none;
  border-radius: 6px;
}
</style>
</head>

<body>

<div id="status" class="offline">● Offline</div>

<h1>Vereinskühlschrank</h1>

<input type="text" id="search" class="search-box" placeholder="Mitglied suchen...">

<div class="section-title">Zuletzt verwendet</div>
<div id="recentMembers" class="member-list"></div>

<div class="section-title">Alle Mitglieder</div>
<div id="memberList" class="member-list"></div>

<button onclick="saveTestEntry()">Test-Entnahme speichern</button>

<script>
const SUPABASE_URL = "https://lzrbcphditfrgvfoswpr.supabase.co";
const SUPABASE_KEY = "sb_publishable_-C9ojxpR5NcQfi2NiEii5w_wi5rVblM";

let members = [];
let selectedMember = null;

// Status prüfen
async function checkConnection() {
  try {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/mitglieder?select=id&limit=1`, {
      headers: {
        apikey: SUPABASE_KEY,
        Authorization: `Bearer ${SUPABASE_KEY}`
      }
    });

    if (res.ok) {
      document.getElementById("status").textContent = "● Online";
      document.getElementById("status").className = "online";
    } else {
      throw new Error();
    }
  } catch {
    document.getElementById("status").textContent = "● Offline";
    document.getElementById("status").className = "offline";
  }
}

// Mitglieder laden
async function loadMembers() {
  const res = await fetch(`${SUPABASE_URL}/rest/v1/mitglieder?select=*`, {
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`
    }
  });

  members = await res.json();
  renderMembers(members);
  renderRecentMembers();
}

// Render Mitgliederliste
function renderMembers(list) {
  const container = document.getElementById("memberList");
  container.innerHTML = "";

  list.forEach(m => {
    const div = document.createElement("div");
    div.className = "member-item";
    div.textContent = m.name;
    div.onclick = () => selectMember(m);
    container.appendChild(div);
  });
}

// Live Suche
document.getElementById("search").addEventListener("input", e => {
  const value = e.target.value.toLowerCase();
  const filtered = members.filter(m => m.name.toLowerCase().includes(value));
  renderMembers(filtered);
});

// Mitglied auswählen
function selectMember(member) {
  selectedMember = member;
  saveRecent(member);
  alert("Ausgewählt: " + member.name);
}

// Zuletzt verwendete speichern
function saveRecent(member) {
  let recent = JSON.parse(localStorage.getItem("recentMembers")) || [];
  recent = recent.filter(m => m.id !== member.id);
  recent.unshift(member);
  recent = recent.slice(0, 10);
  localStorage.setItem("recentMembers", JSON.stringify(recent));
  renderRecentMembers();
}

// Zuletzt anzeigen
function renderRecentMembers() {
  const container = document.getElementById("recentMembers");
  container.innerHTML = "";

  let recent = JSON.parse(localStorage.getItem("recentMembers")) || [];

  recent.forEach(m => {
    const div = document.createElement("div");
    div.className = "member-item";
    div.textContent = m.name;
    div.onclick = () => selectMember(m);
    container.appendChild(div);
  });
}

// Test Eintrag
async function saveTestEntry() {
  if (!selectedMember) {
    alert("Bitte zuerst Mitglied wählen");
    return;
  }

  await fetch(`${SUPABASE_URL}/rest/v1/entnahmen`, {
    method: "POST",
    headers: {
      apikey: SUPABASE_KEY,
      Authorization: `Bearer ${SUPABASE_KEY}`,
      "Content-Type": "application/json",
      Prefer: "return=representation"
    },
    body: JSON.stringify([{
      mitglied_id: selectedMember.id,
      produkt_id: 1,
      menge: 1,
      gesamtpreis: 1,
      bezahlt: false
    }])
  });

  alert("Test-Entnahme gespeichert");
}

// Init
checkConnection();
loadMembers();
document.getElementById("search").focus();
</script>

</body>
</html>
