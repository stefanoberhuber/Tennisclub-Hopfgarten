<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tennisclub Entnahmen</title>

<style>
body{font-family:Arial;margin:0;background:#f4f6f8;}
.page-title{text-align:center;font-size:26px;font-weight:bold;padding:20px 0 10px;}
.section-title{font-size:14px;font-weight:bold;margin-bottom:6px;}
.container{display:flex;gap:20px;padding:20px;}

:root{
  --member-height:42px;
  --visible-members:10;
  --search-height:52px;
}

.column{width:50%;display:flex;flex-direction:column;}

.search{
  height:var(--search-height);
  padding:10px;
  margin-bottom:10px;
  font-size:16px;
  box-sizing:border-box;
}

#recentList{
  height:calc(var(--member-height)*var(--visible-members));
}

#memberList{
  height:calc(
    (var(--member-height)*var(--visible-members))
    - var(--search-height)
    - 10px
  );
}

.list{background:white;border-radius:8px;overflow:hidden;}
.member{
  height:var(--member-height);
  line-height:var(--member-height);
  padding:0 10px;
  border-bottom:1px solid #eee;
  cursor:pointer;
}
.member:hover{background:#f0f0f0;}

/* Tabelle */
.entnahmen-container{padding:20px;}
#entnahmenTable{width:100%;border-collapse:collapse;background:white;font-size:14px;}
#entnahmenTable th{background:#e9ecef;cursor:pointer;padding:8px;border-bottom:1px solid #ddd;}
#entnahmenTable td{padding:6px;border-bottom:1px solid #eee;}
#entnahmenTable input{width:95%;padding:4px;font-size:12px;}

/* Modal */
#modalOverlay{
  position:fixed;inset:0;background:rgba(0,0,0,0.5);
  display:none;justify-content:center;align-items:center;
}
.modal{
  background:white;width:90%;max-width:500px;
  max-height:90vh;border-radius:12px;padding:15px;
  display:flex;flex-direction:column;overflow:hidden;
}
.accordion-header{
  padding:8px;background:#e9ecef;margin-top:6px;
  cursor:pointer;border-radius:6px;font-weight:bold;
}
.accordion-content{
  display:none;grid-template-columns:repeat(2,1fr);
  gap:6px;margin-top:6px;
}
.product-btn{
  padding:6px;font-size:14px;border-radius:6px;
  border:1px solid #ccc;cursor:pointer;
}
.product-btn.active{
  background:#198754;color:white;border-color:#198754;
}
#orderSummary{margin-top:10px;font-size:14px;}
.modal-buttons{margin-top:auto;display:flex;justify-content:space-between;}
.modal-buttons button:last-child{
  background:#198754;color:white;font-weight:bold;
  border:none;padding:10px 16px;
}
  /* Kleiner Spinner neben dem Speichern-Button */
.button-spinner {
  display: inline-block;
  width: 16px;
  height: 16px;
  border: 2px solid #ccc;
  border-top: 2px solid #198754;
  border-radius: 50%;
  margin-left: 8px;
  vertical-align: middle;
  animation: spin 0.8s linear infinite;
  display: none; /* standardmäßig unsichtbar */
}
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}
button{padding:6px 10px;border-radius:6px;border:1px solid #ccc;background:white;cursor:pointer;}


/* Datum-Input: Clear-Button entfernen, Kalender behalten */
input[type="date"]::-webkit-clear-button {
    display: none;
}

input[type="date"]::-moz-clear {
    display: none;
}

input[type="date"]::-ms-clear {
    display: none;
}

</style>
</head>

<body>

<div class="page-title">Entnahme Kühlschrank TC Hopfgarten</div>

<div class="container">
  <div class="column">
    <div class="section-title">Suche</div>
    <input type="text" id="search" class="search" placeholder="Mitglied suchen...">
    <div id="memberList" class="list"></div>
  </div>
  <div class="column">
    <div class="section-title">Letzte aktive Mitglieder</div>
    <div id="recentList" class="list"></div>
  </div>
</div>

<div class="entnahmen-container">
  <div class="section-title">Entnahmen Übersicht</div>
  <div style="overflow:auto;">
    <table id="entnahmenTable">
      <thead id="entnahmenHead"></thead>
      <tbody id="entnahmenBody"></tbody>
    </table>
  </div>
</div>

<div id="modalOverlay">
  <div class="modal">
    <h3 id="modalMemberName"></h3>
    <div id="accordionContainer"></div>
    <div id="orderSummary">Kein Produkt gewählt</div>
    <div class="modal-buttons">
      <button onclick="closeModal()">X</button>
<button id="saveButton" onclick="saveEntry()">Speichern
  <span class="button-spinner" id="saveSpinner"></span>
</button>
    </div>
  </div>
</div>

<script>
const SUPABASE_URL="https://lzrbcphditfrgvfoswpr.supabase.co";
const SUPABASE_KEY="sb_publishable_-C9ojxpR5NcQfi2NiEii5w_wi5rVblM";

let members=[], products=[], entnahmen=[];
let selectedMember = null, selectedProducts = {};
let currentSortColumn = "zeitpunkt",
    currentSortDesc = true,
    columnFilters = {
      zeitpunkt: new Date().toISOString().split("T")[0]
    };

/* --- FETCH --- */
async function fetchData(table){
  const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=*`,{
    headers:{apikey:SUPABASE_KEY,Authorization:`Bearer ${SUPABASE_KEY}`}
  });
  return res.ok ? await res.json() : [];
}

async function loadData(){
  members = await fetchData("mitglieder");
  products = await fetchData("produkte");
  entnahmen = await fetchData("entnahmen");
  renderRecentMembers();
  renderEntnahmenTable();
}
loadData();

/* --- Mitglieder --- */
function renderMembers(filter=""){
  const list = document.getElementById("memberList");
  list.innerHTML = "";
  if(!filter.trim()) return;
  members
    .filter(m => m.name.toLowerCase().includes(filter.toLowerCase()))
    .slice(0,10)
    .forEach(m=>{
      const div = document.createElement("div");
      div.className = "member";
      div.textContent = m.name;
      div.onclick = () => openModal(m.id);
      list.appendChild(div);
    });
}
document.getElementById("search").addEventListener("input", e => renderMembers(e.target.value));

/* --- Recent --- */
function updateRecent(member){
  let recent = JSON.parse(localStorage.getItem("recentMembers")||"[]");
  recent = recent.filter(m => m.id !== member.id);
  recent.unshift(member);
  recent = recent.slice(0,10);
  localStorage.setItem("recentMembers", JSON.stringify(recent));
  renderRecentMembers();
}
function renderRecentMembers(){
  const list = document.getElementById("recentList");
  list.innerHTML = "";
  let recent = JSON.parse(localStorage.getItem("recentMembers")||"[]");
  recent.forEach(m=>{
    const div = document.createElement("div");
    div.className = "member";
    div.textContent = m.name;
    div.onclick = () => openModal(m.id);
    list.appendChild(div);
  });
}

/* --- Modal --- */
function openModal(id){
  selectedMember = members.find(m => m.id == id);
  if(!selectedMember) return;
  selectedProducts = {};
  document.getElementById("modalMemberName").textContent = selectedMember.name;
  document.getElementById("modalOverlay").style.display = "flex";
  renderAccordion();
  updateSummary();
}
function closeModal(){
  document.getElementById("modalOverlay").style.display = "none";
}
document.addEventListener("keydown", e => {
  if(e.key === "Escape") closeModal();
});

/* --- Accordion --- */
function getTopProducts(){
  const count = {};
  entnahmen.forEach(e=>{
    count[e.produkt_id] = (count[e.produkt_id]||0) + (e.menge||0);
  });
  return products
    .map(p=>({...p, count: count[p.id]||0}))
    .sort((a,b)=>b.count - a.count)
    .slice(0,10);
}

function renderAccordion(){
  const c = document.getElementById("accordionContainer");
  c.innerHTML = "";
  createAccordion("Top 10 meistgekauft", getTopProducts(), true);
  createAccordion("Getränke", products.filter(p => p.kategorie === "Getränke"));
  createAccordion("Essen", products.filter(p => p.kategorie === "Essen"));
  createAccordion("Equipment", products.filter(p => p.kategorie === "Equipment"));
}

function createAccordion(title, list, open=false){
  const container = document.getElementById("accordionContainer");
  const header = document.createElement("div");
  header.className = "accordion-header";
  header.textContent = title;

  const content = document.createElement("div");
  content.className = "accordion-content";
  content.style.display = open ? "grid" : "none";

  header.onclick = () => {
    document.querySelectorAll(".accordion-content").forEach(c => c.style.display="none");
    content.style.display = "grid";
  };

  list.forEach(p => {
    const btn = document.createElement("button");
    btn.className = "product-btn";
    btn.id = "product-" + p.id;
    btn.textContent = `${p.name} (${Number(p.preis||0).toFixed(2)}€)`;
    btn.onclick = () => selectProduct(p);
    content.appendChild(btn);
  });

  container.appendChild(header);
  container.appendChild(content);
}

/* --- Produkte --- */
function selectProduct(p){
  if(!selectedProducts[p.id]){
    selectedProducts[p.id] = {...p, qty:1, preis:Number(p.preis)||0};
  } else {
    selectedProducts[p.id].qty++;
  }
  updateSummary();
  updateHighlights();
}

function changeQty(id, delta){
  if(!selectedProducts[id]) return;
  selectedProducts[id].qty += delta;
  if(selectedProducts[id].qty <= 0) delete selectedProducts[id];
  updateSummary();
  updateHighlights();
}

function updateHighlights(){
  document.querySelectorAll(".product-btn").forEach(b => b.classList.remove("active"));
  Object.keys(selectedProducts).forEach(id => {
    const btn = document.getElementById("product-" + id);
    if(btn) btn.classList.add("active");
  });
}

function updateSummary(){
  const c = document.getElementById("orderSummary");
  const items = Object.values(selectedProducts);
  if(!items.length){ c.innerHTML = "Kein Produkt gewählt"; return; }

  let html = "", total = 0;
  items.forEach(p => {
    total += p.qty * p.preis;
    html += `
      <div style="display:flex;justify-content:space-between;margin-bottom:6px;">
        <div>${p.name}</div>
        <div>
          <button onclick="changeQty('${p.id}',-1)">−</button>
          ${p.qty}
          <button onclick="changeQty('${p.id}',1)">+</button>
        </div>
      </div>`;
  });
  html += `<hr><strong>Gesamt: ${total.toFixed(2)} €</strong>`;
  c.innerHTML = html;
}

/* --- Speichern mit Spinner --- */
async function saveEntry() {
  const items = Object.values(selectedProducts);
  if(!items.length) return;

  const spinner = document.getElementById("saveSpinner");
  const button = document.getElementById("saveButton");
  spinner.style.display = "inline-block";
  button.disabled = true;

  try {
    for(const p of items){
      await fetch(`${SUPABASE_URL}/rest/v1/entnahmen`,{
        method:"POST",
        headers:{
          apikey: SUPABASE_KEY,
          Authorization: `Bearer ${SUPABASE_KEY}`,
          "Content-Type":"application/json"
        },
        body: JSON.stringify({
          mitglied_id: selectedMember.id,
          produkt_id: p.id,
          menge: p.qty,
          gesamtpreis: p.qty * p.preis,
          bezahlt: false
        })
      });
    }

    updateRecent(selectedMember);
    entnahmen = await fetchData("entnahmen");
    renderEntnahmenTable();
    closeModal();
  } catch(err){
    console.error(err);
    alert("Fehler beim Speichern!");
  } finally {
    spinner.style.display = "none";
    button.disabled = false;
  }
}

/* --- Tabelle --- */
function formatDate(dateStr){
  if(!dateStr) return "";
  const datePart = dateStr.split("T")[0];
  const parts = datePart.split("-");
  if(parts.length !== 3) return dateStr;
  return `${parts[2]}.${parts[1]}.${parts[0]}`;
}

function renderEntnahmenTable(){
  const head = document.getElementById("entnahmenHead");
  const body = document.getElementById("entnahmenBody");
  head.innerHTML = "";
  body.innerHTML = "";

  if(!entnahmen.length){
    body.innerHTML = "<tr><td>Keine Daten</td></tr>";
    return;
  }

  const memberMap = {};
  members.forEach(m => memberMap[m.id] = m.name);
  const productMap = {};
  products.forEach(p => productMap[p.id] = p.name);

  const columns = [
    {key:"zeitpunkt", label:"Datum"},
    {key:"mitglied_id", label:"Mitglied"},
    {key:"produkt_id", label:"Produkt"},
    {key:"menge", label:"Menge"},
    {key:"gesamtpreis", label:"Gesamt €"}
  ];

  const headerRow = document.createElement("tr");
  const filterRow = document.createElement("tr");

  columns.forEach(col=>{
    const th = document.createElement("th");
    th.textContent = col.label;
    th.onclick = () => {
      if(currentSortColumn === col.key) currentSortDesc = !currentSortDesc;
      else { currentSortColumn = col.key; currentSortDesc = true; }
      renderEntnahmenTable();
    };
    headerRow.appendChild(th);

    const f = document.createElement("th");
    if(col.key === "zeitpunkt"){
      const input = document.createElement("input");
      input.type = "date";
      input.value = columnFilters["zeitpunkt"];
      input.addEventListener("change", e => {
        columnFilters["zeitpunkt"] = e.target.value;
        renderEntnahmenTable();
      });
      input.addEventListener("input", e => {
        if(!e.target.value){
          const today = new Date().toISOString().split("T")[0];
          e.target.value = today;
          columnFilters["zeitpunkt"] = today;
          renderEntnahmenTable();
        }
      });
      f.appendChild(input);
    }
    filterRow.appendChild(f);
  });

  head.appendChild(headerRow);
  head.appendChild(filterRow);

  let filtered = entnahmen.filter(r => {
    if(columnFilters["zeitpunkt"]){
      const filterDate = columnFilters["zeitpunkt"];
      const rowDate = (r.zeitpunkt || "").substring(0,10);
      if(rowDate !== filterDate) return false;
    }
    return true;
  });

  filtered.sort((a,b) => {
    const dateA = new Date(a.zeitpunkt);
    const dateB = new Date(b.zeitpunkt);
    if(dateA < dateB) return 1;
    if(dateA > dateB) return -1;
    return 0;
  });

  filtered.forEach(r=>{
    const tr = document.createElement("tr");
    columns.forEach(col=>{
      const td = document.createElement("td");
      let value = r[col.key];
      if(col.key === "mitglied_id") value = memberMap[value] || "-";
      if(col.key === "produkt_id") value = productMap[value] || "-";
      if(col.key === "zeitpunkt") value = formatDate(value);
      if(col.key === "gesamtpreis") value = Number(value||0).toFixed(2) + " €";
      td.textContent = value;
      tr.appendChild(td);
    });
    body.appendChild(tr);
  });
}
</script>
</body>
</html>
